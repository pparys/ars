set testdir [file dirname $argv0]
source $testdir/tester.tcl

do_test setup-foreign-key-2.0 {
  execsql {
    CREATE TABLE customers (
      id INTEGER PRIMARY KEY,
      company_name TEXT
    );
    CREATE TABLE orders (
      id INTEGER PRIMARY KEY,
      customer_id INTEGER,
      FOREIGN KEY customer_id REFERENCES customers
    );
  CREATE TABLE products (
    id INTEGER PRIMARY KEY,
    stock REAL
  );
    CREATE TABLE order_items (
      id INTEGER PRIMARY KEY,
      order_id INTEGER,
      product_id INTEGER,
      quantity INTEGER,
      FOREIGN KEY order_id REFERENCES orders,
      FOREIGN KEY product_id REFERENCES products
    );
    INSERT INTO customers VALUES(101, 'Client A');
    INSERT INTO customers VALUES(102, 'Client B');
    INSERT INTO orders VALUES(1, 101);
    INSERT INTO orders VALUES(2, 102);
    INSERT INTO products VALUES(1, 50.0);
    INSERT INTO products VALUES(2, 75.0);
    INSERT INTO order_items VALUES(1, 1, 1, 5);
    INSERT INTO order_items VALUES(2, 1, 2, 10);
    INSERT INTO order_items VALUES(3, 2, 1, 7);
  }
} {}

do_test select-order-2.1 {
  execsql {
    SELECT COALESCERoundoder_items.*LIMIT v1fromorder_itemsJOINordersONordersid=order_itemsorder_idJOINcustomersONcustomersid=orderscustomer_idJOINproductsONproductsid=order_itemsproduct_idWHEREcustomerscompany_name='Client B'  ORDERBYcustomerscompany_nameLIMIT1;
  }
} {10 85.0 102 'Client B'}

finish_test